<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Verifying your login to ISRS">
  <title>Verifying Login - ISRS</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">

  <script src="/js/theme.js"></script>
  <script src="/js/analytics.js"></script>
  <script src="/js/member-auth.js"></script>
</head>
<body>
  <header id="site-header"></header>

  <main id="main-content">
    <div class="container" style="max-width: 600px; margin: 4rem auto; padding: 2rem;">

      <!-- Loading State -->
      <div id="loadingState" style="text-align: center;">
        <div class="spinner" style="margin: 2rem auto 1rem; width: 60px; height: 60px; border: 4px solid var(--border-color); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <h1 style="color: var(--text-light); margin-bottom: 0.5rem;">Verifying Your Login</h1>
        <p style="color: var(--text-light);">Please wait while we securely log you in...</p>
      </div>

      <!-- Error State -->
      <div id="errorState" style="display: none; text-align: center;">
        <div style="font-size: 4rem; color: #c00; margin-bottom: 1rem;">✗</div>
        <h1 style="color: #c00; margin-bottom: 1rem;">Login Failed</h1>
        <p id="errorMessage" style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem; color: var(--text-color);">
          This login link is invalid or has expired.
        </p>
        <div style="padding: 1.5rem; background: #fef8e7; border: 1px solid #f4d03f; border-radius: 4px; margin-bottom: 2rem;">
          <p style="margin: 0; color: var(--text-color);">
            <strong>Troubleshooting:</strong><br>
            • Magic links expire after 15 minutes<br>
            • Each link can only be used once<br>
            • Make sure you clicked the latest link sent to your email
          </p>
        </div>
        <p>
          <a href="/member/login.html" class="btn btn-primary">Request New Login Link</a>
        </p>
        <p style="margin-top: 1rem;">
          <a href="/" class="btn btn-secondary">Return to Home</a>
        </p>
      </div>

    </div>
  </main>

  <footer id="site-footer"></footer>

  <script src="/js/components.js"></script>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');

    async function verifyLogin() {
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        showError('No login token provided in the URL.');
        return;
      }

      try {
        // Step 1: Verify the magic link token
        console.log('Verifying magic link token...');
        const verifyResponse = await MemberAuth.verifyMagicLink(token);

        if (!verifyResponse.success) {
          throw new Error(verifyResponse.error || 'Failed to verify login link');
        }

        console.log('Magic link verified successfully');

        // Step 2: Get profile to check if first-time setup is needed
        console.log('Fetching user profile...');
        const profileResponse = await MemberAuth.getProfile();

        if (!profileResponse.success) {
          throw new Error('Failed to load profile');
        }

        // Step 3: Redirect based on setup status
        const requiresSetup = profileResponse.data.requiresFirstTimeSetup;

        console.log('Setup required:', requiresSetup);

        if (requiresSetup) {
          // First-time user or incomplete profile - go to welcome page
          window.location.href = '/member/welcome.html';
        } else {
          // Returning user with complete profile - go to profile page
          // Check if there was a redirect URL specified
          const redirectUrl = urlParams.get('redirect') || '/member/profile.html';
          window.location.href = redirectUrl;
        }

      } catch (error) {
        console.error('Verification error:', error);
        showError(error.message || 'An unexpected error occurred during login verification.');
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      loadingState.style.display = 'none';
      errorState.style.display = 'block';
    }

    // Auto-verify when page loads
    document.addEventListener('DOMContentLoaded', verifyLogin);
  </script>
</body>
</html>
