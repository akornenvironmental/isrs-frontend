<!-- AI Assistant Component - Include in all admin pages with: <script src="/components/ai-assistant.html"></script> -->
<div id="aiAssistantContainer"></div>

<script>
document.getElementById('aiAssistantContainer').innerHTML = `
<style>
  .ai-assistant-tab {
    position: fixed;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    background: linear-gradient(180deg, #3b82f6 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 20px 12px;
    cursor: pointer;
    border-top-left-radius: 8px;
    border-bottom-left-radius: 8px;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    writing-mode: vertical-rl;
    text-orientation: mixed;
    z-index: 9998;
    font-weight: 500;
  }
  .ai-assistant-tab:hover { background: linear-gradient(180deg, #2563eb 0%, #6d28d9 100%); }
  .ai-assistant-panel {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 450px;
    background: white;
    border-left: 2px solid #667eea;
    box-shadow: -4px 0 20px rgba(0,0,0,0.15);
    display: none;
    flex-direction: column;
    z-index: 9999;
  }
  .ai-assistant-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }
  .ai-assistant-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
  .ai-example-btn {
    width: 100%;
    text-align: left;
    padding: 0.75rem 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    cursor: pointer;
    margin-bottom: 0.5rem;
  }
  .ai-example-btn:hover { background: #eff6ff; border-color: #bfdbfe; }
  .ai-example-btn::before { content: 'â†’'; color: #3b82f6; margin-right: 0.5rem; }
  .ai-loading-spinner {
    display: inline-block;
    width: 3rem;
    height: 3rem;
    border: 2px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .ai-input-form { display: flex; gap: 0.5rem; padding: 1rem; border-top: 1px solid #e5e7eb; }
  .ai-input-form input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }
  .ai-submit-btn {
    padding: 0.75rem 1.5rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
  }
  .ai-submit-btn:hover:not(:disabled) { background: #2563eb; }
  .ai-submit-btn:disabled { background: #d1d5db; cursor: not-allowed; }
</style>

<button id="aiTab" class="ai-assistant-tab" onclick="window.toggleAI()">
  <span style="font-size:1.5rem;">ðŸ¤–</span> AI Assistant
</button>

<div id="aiPanel" class="ai-assistant-panel">
  <div class="ai-assistant-header">
    <div style="flex:1;">
      <h3 style="margin:0 0 0.25rem 0;font-size:1.125rem;font-weight:bold;">AI Query Assistant</h3>
      <p style="margin:0;font-size:0.75rem;color:#6b7280;">Ask questions about your ISRS data</p>
    </div>
    <button onclick="window.toggleAI()" style="border:none;background:none;font-size:2rem;cursor:pointer;color:#9ca3af;">&times;</button>
  </div>
  
  <div id="aiContent" class="ai-assistant-content">
    <div id="aiExamples">
      <p style="font-size:0.875rem;color:#6b7280;margin-bottom:1rem;">Try asking:</p>
      <button class="ai-example-btn" onclick="window.setAIQuery('How many funding prospects are in the pipeline?')">How many funding prospects are in the pipeline?</button>
      <button class="ai-example-btn" onclick="window.setAIQuery('What is our email campaign open rate?')">What is our email campaign open rate?</button>
      <button class="ai-example-btn" onclick="window.setAIQuery('Show top organizations by contact count')">Show top organizations by contact count</button>
      <button class="ai-example-btn" onclick="window.setAIQuery('Which prospects need follow-up?')">Which prospects need follow-up?</button>
      <button class="ai-example-btn" onclick="window.setAIQuery('How many abstracts submitted?')">How many abstracts submitted?</button>
    </div>
    <div id="aiLoading" style="display:none;text-align:center;padding:3rem;">
      <div class="ai-loading-spinner"></div>
      <p style="color:#6b7280;margin-top:1rem;">Analyzing...</p>
    </div>
    <div id="aiResponse" style="display:none;"></div>
  </div>

  <form id="aiForm" class="ai-input-form" onsubmit="window.submitAI(event)">
    <input type="text" id="aiInput" placeholder="Ask about your data..." required />
    <button type="submit" class="ai-submit-btn" id="aiBtn">Ask</button>
  </form>
</div>
`;

window.toggleAI = function() {
  const panel = document.getElementById('aiPanel');
  const tab = document.getElementById('aiTab');
  if (panel.style.display === 'flex') {
    panel.style.display = 'none';
    tab.style.display = 'block';
  } else {
    panel.style.display = 'flex';
    tab.style.display = 'none';
    document.getElementById('aiInput').focus();
  }
};

window.setAIQuery = function(q) {
  document.getElementById('aiInput').value = q;
  document.getElementById('aiInput').focus();
};

window.submitAI = async function(e) {
  e.preventDefault();
  const query = document.getElementById('aiInput').value.trim();
  if (!query) return;

  document.getElementById('aiExamples').style.display = 'none';
  document.getElementById('aiResponse').style.display = 'none';
  document.getElementById('aiLoading').style.display = 'block';
  document.getElementById('aiBtn').disabled = true;
  document.getElementById('aiBtn').textContent = 'Analyzing...';

  try {
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://isrs-database-backend.onrender.com';
    const token = localStorage.getItem('token');
    const response = await fetch(\`\${API_BASE}/api/ai/query\`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': \`Bearer \${token}\` },
      body: JSON.stringify({ query })
    });
    const data = await response.json();
    
    document.getElementById('aiResponse').innerHTML = \`
      <div style="background:#f9fafb;border-radius:0.5rem;padding:1rem;">
        <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
          <h4 style="font-size:1.25rem;font-weight:bold;margin:0;">\${data.response?.title || 'Results'}</h4>
          <button onclick="document.getElementById('aiResponse').style.display='none';document.getElementById('aiExamples').style.display='block';document.getElementById('aiInput').value='';" 
                  style="padding:0.5rem 1rem;background:#3b82f6;color:white;border:none;border-radius:0.375rem;cursor:pointer;">New Query</button>
        </div>
        <div style="background:white;padding:1rem;border-radius:0.375rem;border:1px solid #e5e7eb;">
          \${data.response?.content || 'No results'}
        </div>
        \${data.response?.insight ? \`<div style="background:#f3f4f6;padding:0.75rem;border-radius:0.375rem;margin-top:1rem;font-size:0.875rem;"><strong>ðŸ’¡ Insight:</strong> \${data.response.insight}</div>\` : ''}
      </div>
    \`;
    document.getElementById('aiResponse').style.display = 'block';
  } catch (error) {
    document.getElementById('aiResponse').innerHTML = '<div style="background:#fee2e2;color:#991b1b;padding:1rem;border-radius:0.5rem;">Error connecting to AI assistant</div>';
    document.getElementById('aiResponse').style.display = 'block';
  } finally {
    document.getElementById('aiLoading').style.display = 'none';
    document.getElementById('aiBtn').disabled = false;
    document.getElementById('aiBtn').textContent = 'Ask';
  }
};

// Show tab on load
document.getElementById('aiTab').style.display = 'block';
</script>
