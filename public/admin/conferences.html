<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conference Registrations - ISRS Admin</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin-layout.css">
  <link rel="stylesheet" href="/css/admin-unified.css">
  <style>
    /* Inline editing styles */
    .editable-cell { cursor: pointer; position: relative; }
    .editable-cell:hover { background: var(--admin-primary-light); }
    .editable-cell input, .editable-cell select {
      width: 100%;
      padding: 0.25rem 0.5rem;
      border: 2px solid var(--admin-primary);
      border-radius: var(--admin-radius-sm);
      font-size: inherit;
      background: var(--admin-surface);
      color: var(--admin-text);
    }
    .editable-cell input:focus, .editable-cell select:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--admin-primary-light);
    }
  </style>
</head>
<body class="admin-page">
  <div class="admin-content-padded">
    <!-- Page Header -->
    <div class="admin-page-header" style="background: transparent; border: none; padding: 0 0 var(--admin-space-xl) 0;">
      <h1>Conference 2026 Registrations</h1>
    </div>

    <!-- Statistics -->
    <div class="admin-stats-grid" style="padding: 0; margin-bottom: var(--admin-space-xl);">
      <div class="admin-stat-card" style="border-left: 4px solid var(--admin-primary);">
        <div class="admin-stat-label">Total Registrations</div>
        <div class="admin-stat-value" id="totalRegistrations">0</div>
      </div>
      <div class="admin-stat-card" style="border-left: 4px solid var(--admin-success);">
        <div class="admin-stat-label">Paid Registrations</div>
        <div class="admin-stat-value" id="paidRegistrations">0</div>
      </div>
      <div class="admin-stat-card" style="border-left: 4px solid var(--admin-warning);">
        <div class="admin-stat-label">Pending Payments</div>
        <div class="admin-stat-value" id="pendingPayments">0</div>
      </div>
      <div class="admin-stat-card" style="border-left: 4px solid var(--admin-accent);">
        <div class="admin-stat-label">Total Revenue</div>
        <div class="admin-stat-value" id="totalRevenue">$0</div>
      </div>
    </div>

    <!-- Registrations Table -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2>All Registrations</h2>
      </div>

      <div class="admin-toolbar">
        <div class="admin-toolbar-left">
          <input type="text" class="admin-input admin-search" id="searchBox" placeholder="Search registrations...">
          <select class="admin-select" id="paymentFilter" onchange="loadRegistrations()">
            <option value="">All Payments</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div class="admin-toolbar-right">
          <a href="/conference/register.html" class="admin-btn admin-btn-secondary" target="_blank">Public Registration</a>
          <button class="admin-btn admin-btn-primary" onclick="exportCSV()">Export</button>
        </div>
      </div>

      <div class="admin-table-wrapper">
        <div id="tableContent">
          <div class="admin-loading">
            <span class="admin-spinner"></span>
            Loading registrations...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://isrs-database-backend.onrender.com';
    let allRegistrations = [];
    let currentConference = null;
    let currentSort = { column: null, direction: 'asc' };

    window.addEventListener('DOMContentLoaded', async () => {
      const sessionToken = localStorage.getItem('isrs_session_token');
      if (!sessionToken) {
        window.location.href = '/admin/';
        return;
      }

      await loadConference();
      await loadStats();
      await loadRegistrations();
    });

    async function loadConference() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/conference/active`);
        const data = await response.json();
        if (data.success) currentConference = data.data;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadStats() {
      if (!currentConference) return;
      const sessionToken = localStorage.getItem('isrs_session_token');
      try {
        const response = await fetch(`${API_BASE_URL}/api/admin/conference/stats?conference_id=${currentConference.id}`, {
          headers: { 'Authorization': `Bearer ${sessionToken}` }
        });
        const data = await response.json();
        if (data.success) {
          const s = data.data;
          document.getElementById('totalRegistrations').textContent = s.total_registrations || 0;
          document.getElementById('paidRegistrations').textContent = s.paid_registrations || 0;
          document.getElementById('pendingPayments').textContent = s.pending_payments || 0;
          document.getElementById('totalRevenue').textContent = `$${(s.total_revenue || 0).toLocaleString()}`;
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadRegistrations() {
      if (!currentConference) return;
      const sessionToken = localStorage.getItem('isrs_session_token');
      const paymentFilter = document.getElementById('paymentFilter').value;
      let url = `${API_BASE_URL}/api/admin/conference/registrations?conference_id=${currentConference.id}`;
      if (paymentFilter) url += `&payment_status=${paymentFilter}`;

      try {
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${sessionToken}` }
        });
        const data = await response.json();
        if (data.success) {
          allRegistrations = data.data;
          displayRegistrations(allRegistrations);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function displayRegistrations(regs) {
      if (regs.length === 0) {
        document.getElementById('tableContent').innerHTML = `
          <div class="admin-empty">
            <div class="admin-empty-icon">ðŸ“‹</div>
            <div class="admin-empty-title">No registrations found</div>
            <div class="admin-empty-text">Registrations will appear here once people sign up.</div>
          </div>
        `;
        return;
      }

      const getSortIndicator = (column) => {
        if (currentSort.column !== column) return '';
        return currentSort.direction === 'asc' ? ' â†‘' : ' â†“';
      };

      const html = `
        <table class="admin-table">
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)"></th>
              <th class="sortable" onclick="sortBy('registration_number')">Reg #${getSortIndicator('registration_number')}</th>
              <th class="sortable" onclick="sortBy('name')">Name${getSortIndicator('name')}</th>
              <th class="sortable" onclick="sortBy('user_email')">Email${getSortIndicator('user_email')}</th>
              <th class="sortable" onclick="sortBy('organization_name')">Organization${getSortIndicator('organization_name')}</th>
              <th class="sortable" onclick="sortBy('country')">Country${getSortIndicator('country')}</th>
              <th class="sortable" onclick="sortBy('registration_type')">Type${getSortIndicator('registration_type')}</th>
              <th class="sortable" onclick="sortBy('registration_fee')">Fee${getSortIndicator('registration_fee')}</th>
              <th class="sortable" onclick="sortBy('payment_status')">Payment${getSortIndicator('payment_status')}</th>
              <th class="sortable" onclick="sortBy('status')">Status${getSortIndicator('status')}</th>
            </tr>
          </thead>
          <tbody>
            ${regs.map(r => `
              <tr>
                <td style="text-align: center;"><input type="checkbox" class="row-checkbox" value="${r.id}" onchange="updateSelectAllState()"></td>
                <td>${r.registration_number}</td>
                <td>${r.first_name} ${r.last_name}</td>
                <td>${r.user_email}</td>
                <td class="editable-cell" onclick="editRegCell(this, ${r.id}, 'organization_name')" title="Click to edit">${r.organization_name || '-'}</td>
                <td class="editable-cell" onclick="editRegCell(this, ${r.id}, 'country')" title="Click to edit">${r.country || '-'}</td>
                <td class="editable-cell" onclick="editRegCell(this, ${r.id}, 'registration_type')" title="Click to edit">${r.registration_type}</td>
                <td>$${r.registration_fee}</td>
                <td class="editable-cell" onclick="editRegCell(this, ${r.id}, 'payment_status')" title="Click to edit"><span class="admin-badge admin-badge-${r.payment_status === 'paid' ? 'success' : 'warning'}">${r.payment_status}</span></td>
                <td class="editable-cell" onclick="editRegCell(this, ${r.id}, 'status')" title="Click to edit"><span class="admin-badge admin-badge-${r.status === 'confirmed' ? 'success' : 'warning'}">${r.status}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      document.getElementById('tableContent').innerHTML = html;

      // Search
      document.getElementById('searchBox').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allRegistrations.filter(r => JSON.stringify(r).toLowerCase().includes(term));
        displayRegistrations(filtered);
      });
    }

    function sortBy(column) {
      // Toggle direction if clicking same column
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }

      const sorted = [...allRegistrations].sort((a, b) => {
        let aVal, bVal;

        // Get values based on column
        if (column === 'name') {
          aVal = `${a.first_name} ${a.last_name}`.toLowerCase();
          bVal = `${b.first_name} ${b.last_name}`.toLowerCase();
        } else if (column === 'registration_fee') {
          aVal = parseFloat(a[column]) || 0;
          bVal = parseFloat(b[column]) || 0;
        } else {
          aVal = (a[column] || '').toString().toLowerCase();
          bVal = (b[column] || '').toString().toLowerCase();
        }

        // Compare
        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      // Apply search filter if search box has value
      const searchBox = document.getElementById('searchBox');
      if (searchBox && searchBox.value) {
        const term = searchBox.value.toLowerCase();
        const filtered = sorted.filter(r => JSON.stringify(r).toLowerCase().includes(term));
        displayRegistrations(filtered);
      } else {
        displayRegistrations(sorted);
      }
    }

    function toggleSelectAll(checked) {
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(cb => cb.checked = checked);
    }

    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('.row-checkbox');
      const selectAll = document.getElementById('selectAll');
      if (!selectAll) return;

      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      const someChecked = Array.from(checkboxes).some(cb => cb.checked);

      selectAll.checked = allChecked;
      selectAll.indeterminate = someChecked && !allChecked;
    }

    function getSelectedRegistrations() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }

    function exportCSV() {
      const headers = ['Reg #', 'First Name', 'Last Name', 'Email', 'Organization', 'Country', 'Type', 'Fee', 'Payment', 'Status'];
      const rows = allRegistrations.map(r => [
        r.registration_number,
        r.first_name,
        r.last_name,
        r.user_email,
        r.organization_name || '',
        r.country || '',
        r.registration_type,
        r.registration_fee,
        r.payment_status,
        r.status
      ]);

      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `registrations-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function logout() {
      localStorage.clear();
      window.location.href = '/admin/';
    }

    // Inline cell editing for conference registrations
    function editRegCell(cell, regId, field) {
      // Prevent double editing
      if (cell.querySelector('input, select')) return;

      // Extract text from badge if present
      const badge = cell.querySelector('.admin-badge');
      const currentValue = badge ? badge.textContent.trim() : (cell.textContent.trim() === '-' ? '' : cell.textContent.trim());

      const registration = allRegistrations.find(r => r.id === regId);
      if (!registration) return;

      // Store original value
      cell.setAttribute('data-original', currentValue);
      cell.setAttribute('data-original-html', cell.innerHTML);

      // Create input element (use select for specific fields)
      let inputElement;

      if (field === 'registration_type') {
        inputElement = document.createElement('select');
        inputElement.innerHTML = `
          <option value="member" ${currentValue === 'member' ? 'selected' : ''}>Member</option>
          <option value="non-member" ${currentValue === 'non-member' ? 'selected' : ''}>Non-member</option>
          <option value="student" ${currentValue === 'student' ? 'selected' : ''}>Student</option>
          <option value="speaker" ${currentValue === 'speaker' ? 'selected' : ''}>Speaker</option>
          <option value="exhibitor" ${currentValue === 'exhibitor' ? 'selected' : ''}>Exhibitor</option>
        `;
      } else if (field === 'payment_status') {
        inputElement = document.createElement('select');
        inputElement.innerHTML = `
          <option value="pending" ${currentValue === 'pending' ? 'selected' : ''}>Pending</option>
          <option value="paid" ${currentValue === 'paid' ? 'selected' : ''}>Paid</option>
          <option value="refunded" ${currentValue === 'refunded' ? 'selected' : ''}>Refunded</option>
          <option value="cancelled" ${currentValue === 'cancelled' ? 'selected' : ''}>Cancelled</option>
        `;
      } else if (field === 'status') {
        inputElement = document.createElement('select');
        inputElement.innerHTML = `
          <option value="pending" ${currentValue === 'pending' ? 'selected' : ''}>Pending</option>
          <option value="confirmed" ${currentValue === 'confirmed' ? 'selected' : ''}>Confirmed</option>
          <option value="cancelled" ${currentValue === 'cancelled' ? 'selected' : ''}>Cancelled</option>
          <option value="waitlist" ${currentValue === 'waitlist' ? 'selected' : ''}>Waitlist</option>
        `;
      } else {
        inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.value = currentValue;
      }

      inputElement.style.width = '100%';
      inputElement.style.padding = '4px 8px';
      inputElement.style.border = '2px solid var(--admin-primary)';
      inputElement.style.borderRadius = '4px';
      inputElement.style.fontSize = 'inherit';
      inputElement.style.background = 'var(--admin-surface)';
      inputElement.style.color = 'var(--admin-text)';

      // Clear cell and add input
      cell.textContent = '';
      cell.appendChild(inputElement);
      inputElement.focus();
      if (inputElement.select) inputElement.select();

      // Handle save on blur or enter
      const saveEdit = async () => {
        const newValue = (inputElement.value || '').trim();
        const originalValue = cell.getAttribute('data-original');

        // If no change, restore original
        if (newValue === originalValue) {
          cell.innerHTML = cell.getAttribute('data-original-html');
          return;
        }

        // Show saving state
        cell.innerHTML = '<span style="color: var(--admin-primary);">Saving...</span>';

        try {
          const sessionToken = localStorage.getItem('isrs_session_token');
          const response = await fetch(`${API_BASE_URL}/api/admin/conference/registrations/${registration.id}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${sessionToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ [field]: newValue })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Update local data
            registration[field] = newValue;

            // Display updated value with appropriate badge if needed
            if (field === 'payment_status') {
              const badgeClass = newValue === 'paid' ? 'success' : 'warning';
              cell.innerHTML = `<span class="admin-badge admin-badge-${badgeClass}">${newValue}</span>`;
            } else if (field === 'status') {
              const badgeClass = newValue === 'confirmed' ? 'success' : 'warning';
              cell.innerHTML = `<span class="admin-badge admin-badge-${badgeClass}">${newValue}</span>`;
            } else {
              cell.textContent = newValue || '-';
            }

            showToast('Field updated successfully', 'success');
          } else {
            cell.innerHTML = cell.getAttribute('data-original-html');
            showToast('Failed to update: ' + (data.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          cell.innerHTML = cell.getAttribute('data-original-html');
          showToast('Error updating field: ' + error.message, 'error');
        }
      };

      inputElement.addEventListener('blur', saveEdit);
      inputElement.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          inputElement.blur();
        }
        if (e.key === 'Escape') {
          cell.innerHTML = cell.getAttribute('data-original-html');
        }
      });
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 24px;
        background: ${type === 'success' ? 'var(--admin-success)' : 'var(--admin-danger)'};
        color: white;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000;
        font-size: 14px;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>

  <!-- Email Utils -->
  <script src="/js/email-utils.js"></script>

  <!-- Admin Layout -->
  <script src="/js/admin-layout.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      loadAdminLayout('conferences');
    });
  </script>

  <!-- Feedback Widget -->
  <script src="/js/feedback-widget.js"></script>
  <script>
    initFeedbackWidget({ isAdminPortal: true });
  </script>
</body>
</html>
