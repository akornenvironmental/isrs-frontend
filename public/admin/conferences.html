<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conference Registrations - ISRS Admin</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/admin/admin-styles.css">
  <link rel="stylesheet" href="/css/admin-layout.css">
  <style>
    body { background: var(--light-gray); margin: 0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-left: 4px solid var(--primary-blue); }
    .stat-card.revenue { border-left-color: var(--accent-teal); }
    .stat-card.pending { border-left-color: #ffc107; }
    .stat-label { color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem; }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary-blue); }
    .data-table { background: var(--white); border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); overflow: hidden; margin-bottom: 2rem; }
    .table-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .table-header h2 { font-family: 'Marcellus', Georgia, serif; font-size: 1.75rem; margin: 0 0 1rem 0; color: var(--primary-blue); }
    .toolbar { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .toolbar-left, .toolbar-right { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .search-box, .filter-select { padding: 0.375rem 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: inherit; font-size: 0.75rem; }
    .search-box { width: 300px; }
    /* Buttons - Compact SAFMC Style */
    .btn { padding: 0.375rem 0.75rem; background: var(--primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s; text-decoration: none; display: inline-block; }
    .btn:hover { opacity: 0.9; }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover { opacity: 0.9; }
    /* Table - SAFMC Compact Spacing */
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #f9fafb; position: sticky; top: 0; z-index: 10; }
    th { padding: 0.375rem 0.5rem; text-align: left; font-weight: 500; color: #6b7280; border-bottom: 1px solid #e5e7eb; white-space: nowrap; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
    td { padding: 0.375rem 0.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; color: #111827; }
    tbody { background: white; }
    tbody tr { border-bottom: 1px solid #e5e7eb; }
    tbody tr:hover { background: #f9fafb; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .status-paid { background: #d4edda; color: #155724; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-confirmed { background: #d4edda; color: #155724; }
    .loading { text-align: center; padding: 3rem; color: var(--text-light); }
    .loading::before { content: ''; display: block; width: 40px; height: 40px; margin: 0 auto 1rem; border: 3px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .action-btn { padding: 0.25rem 0.5rem; background: var(--primary-blue); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-right: 0.25rem; }
    .action-btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="font-family: 'Marcellus', Georgia, serif; color: var(--primary-blue); margin-bottom: 2rem;">Conference 2026 Registrations</h1>

    <!-- Statistics -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-label">Total Registrations</div>
        <div class="stat-value" id="totalRegistrations">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Paid Registrations</div>
        <div class="stat-value" id="paidRegistrations">0</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-label">Pending Payments</div>
        <div class="stat-value" id="pendingPayments">0</div>
      </div>
      <div class="stat-card revenue">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value" id="totalRevenue">$0</div>
      </div>
    </div>

    <!-- Registrations Table -->
    <div class="data-table">
      <div class="table-header">
        <h2>All Registrations</h2>
        <div class="toolbar">
          <div class="toolbar-left">
            <input type="text" class="search-box" id="searchBox" placeholder="Search registrations...">
            <select class="filter-select" id="paymentFilter" onchange="loadRegistrations()">
              <option value="">All Payments</option>
              <option value="paid">Paid</option>
              <option value="pending">Pending</option>
            </select>
          </div>
          <div class="toolbar-right">
            <a href="/conference/register.html" class="btn" target="_blank">Public Registration</a>
            <button class="btn" onclick="exportCSV()">Export</button>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <div id="tableContent">
          <div class="loading">Loading registrations...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://isrs-database-backend.onrender.com';
    let allRegistrations = [];
    let currentConference = null;

    window.addEventListener('DOMContentLoaded', async () => {
      const sessionToken = localStorage.getItem('isrs_session');
      if (!sessionToken) {
        window.location.href = '/admin/';
        return;
      }

      await loadConference();
      await loadStats();
      await loadRegistrations();
    });

    async function loadConference() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/conference/active`);
        const data = await response.json();
        if (data.success) currentConference = data.data;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadStats() {
      if (!currentConference) return;
      const sessionToken = localStorage.getItem('isrs_session');
      try {
        const response = await fetch(`${API_BASE_URL}/api/admin/conference/stats?conference_id=${currentConference.id}`, {
          headers: { 'Authorization': `Bearer ${sessionToken}` }
        });
        const data = await response.json();
        if (data.success) {
          const s = data.data;
          document.getElementById('totalRegistrations').textContent = s.total_registrations || 0;
          document.getElementById('paidRegistrations').textContent = s.paid_registrations || 0;
          document.getElementById('pendingPayments').textContent = s.pending_payments || 0;
          document.getElementById('totalRevenue').textContent = `$${(s.total_revenue || 0).toLocaleString()}`;
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadRegistrations() {
      if (!currentConference) return;
      const sessionToken = localStorage.getItem('isrs_session');
      const paymentFilter = document.getElementById('paymentFilter').value;
      let url = `${API_BASE_URL}/api/admin/conference/registrations?conference_id=${currentConference.id}`;
      if (paymentFilter) url += `&payment_status=${paymentFilter}`;

      try {
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${sessionToken}` }
        });
        const data = await response.json();
        if (data.success) {
          allRegistrations = data.data;
          displayRegistrations(allRegistrations);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function displayRegistrations(regs) {
      if (regs.length === 0) {
        document.getElementById('tableContent').innerHTML = '<p style="text-align: center; padding: 2rem;">No registrations found</p>';
        return;
      }

      const html = `
        <table>
          <thead>
            <tr>
              <th>Reg #</th>
              <th>Name</th>
              <th>Email</th>
              <th>Organization</th>
              <th>Country</th>
              <th>Type</th>
              <th>Fee</th>
              <th>Payment</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${regs.map(r => `
              <tr>
                <td>${r.registration_number}</td>
                <td>${r.first_name} ${r.last_name}</td>
                <td>${r.user_email}</td>
                <td>${r.organization_name || '-'}</td>
                <td>${r.country || '-'}</td>
                <td>${r.registration_type}</td>
                <td>$${r.registration_fee}</td>
                <td><span class="status-badge status-${r.payment_status}">${r.payment_status}</span></td>
                <td><span class="status-badge status-${r.status}">${r.status}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      document.getElementById('tableContent').innerHTML = html;

      // Search
      document.getElementById('searchBox').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allRegistrations.filter(r => JSON.stringify(r).toLowerCase().includes(term));
        displayRegistrations(filtered);
      });
    }

    function exportCSV() {
      const headers = ['Reg #', 'First Name', 'Last Name', 'Email', 'Organization', 'Country', 'Type', 'Fee', 'Payment', 'Status'];
      const rows = allRegistrations.map(r => [
        r.registration_number,
        r.first_name,
        r.last_name,
        r.user_email,
        r.organization_name || '',
        r.country || '',
        r.registration_type,
        r.registration_fee,
        r.payment_status,
        r.status
      ]);

      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `registrations-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function logout() {
      localStorage.clear();
      window.location.href = '/admin/';
    }
  </script>

  <!-- Email Utils -->
  <script src="/js/email-utils.js"></script>

  <!-- Admin Layout -->
  <script src="/js/admin-layout.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      loadAdminLayout('conferences');
    });
  </script>

  <!-- Feedback Widget -->
  <script src="/js/feedback-widget.js"></script>
  <script>
    initFeedbackWidget({ isAdminPortal: true });
  </script>
</body>
</html>
