<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funding Pipeline | ISRS Admin</title>
  <link rel="stylesheet" href="/css/admin-unified.css">
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: var(--admin-bg, linear-gradient(135deg, #1e3c72 0%, #2a5298 100%));
      min-height: 100vh;
    }

    .admin-header {
      background: var(--admin-surface, rgba(255, 255, 255, 0.95));
      padding: 1rem 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .admin-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1800px;
      margin: 0 auto;
    }

    .admin-nav a {
      margin: 0 0.75rem;
      text-decoration: none;
      color: #2a5298;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .admin-nav a:hover {
      background: #e8f0fe;
    }

    .admin-nav a.active {
      background: #2a5298;
      color: white;
    }

    .pipeline-container {
      padding: 2rem;
      max-width: 1800px;
      margin: 0 auto;
    }

    .pipeline-header {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .pipeline-header h1 {
      margin: 0 0 1rem 0;
      color: #1e3c72;
    }

    .pipeline-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .pipeline-board {
      display: flex;
      gap: 1.5rem;
      overflow-x: auto;
      padding-bottom: 2rem;
    }

    .pipeline-column {
      flex: 0 0 320px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: calc(100vh - 350px);
      display: flex;
      flex-direction: column;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e0e0e0;
    }

    .column-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: #1e3c72;
    }

    .column-count {
      background: #2a5298;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
    }

    .column-value {
      font-size: 0.9rem;
      color: #16a34a;
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .cards-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .prospect-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: grab;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .prospect-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .prospect-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }

    .card-title {
      font-weight: 600;
      color: #1e3c72;
      font-size: 1rem;
      flex: 1;
    }

    .card-amount {
      color: #16a34a;
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      margin-left: 0.5rem;
    }

    .card-meta {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }

    .tag {
      background: #e8f0fe;
      color: #2a5298;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e0e0e0;
    }

    .card-btn {
      flex: 1;
      padding: 0.4rem;
      border: none;
      background: #f3f4f6;
      color: #374151;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .card-btn:hover {
      background: #e5e7eb;
    }

    .drag-over {
      border: 2px dashed #2a5298;
      background: #e8f0fe;
    }

    .fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      margin: 0;
      color: #1e3c72;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
      color: #374151;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: white;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <nav class="admin-nav">
      <div>
        <a href="/admin/dashboard.html">Dashboard</a>
        <a href="/admin/contacts.html">Contacts</a>
        <a href="/admin/organizations.html">Organizations</a>
        <a href="/admin/funding.html">Funding (Legacy)</a>
        <a href="/admin/funding-pipeline.html" class="active">Pipeline</a>
        <a href="/admin/import.html">Import</a>
        <a href="/admin/votes.html">Board Votes</a>
        <a href="/admin/conferences.html">Conferences</a>
      </div>
      <a href="#" onclick="logout()" style="color: #dc2626;">Logout</a>
    </nav>
  </header>

  <div class="pipeline-container">
    <div class="pipeline-header">
      <h1>üí∞ Funding Pipeline</h1>
      <div class="pipeline-stats" id="stats">
        <div class="stat-card">
          <div class="stat-label">Total Pipeline Value</div>
          <div class="stat-value" id="stat-total">$0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Weighted Value</div>
          <div class="stat-value" id="stat-weighted">$0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active Prospects</div>
          <div class="stat-value" id="stat-active">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Overdue Actions</div>
          <div class="stat-value" id="stat-overdue">0</div>
        </div>
      </div>
    </div>

    <div class="pipeline-board" id="board">
      <div class="loading">Loading pipeline...</div>
    </div>
  </div>

  <button class="fab" onclick="showAddProspectModal()">+</button>

  <!-- Add/Edit Prospect Modal -->
  <div class="modal" id="prospectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Prospect</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <form id="prospectForm" onsubmit="saveProspect(event)">
        <input type="hidden" id="prospectId">

        <div class="form-group">
          <label>Organization Name *</label>
          <input type="text" id="organizationName" required>
        </div>

        <div class="form-group">
          <label>Contact Person</label>
          <input type="text" id="contactPerson">
        </div>

        <div class="form-group">
          <label>Estimated Amount *</label>
          <input type="number" id="estimatedAmount" step="0.01" required>
        </div>

        <div class="form-group">
          <label>Probability (%)</label>
          <input type="number" id="probability" min="0" max="100" value="50">
        </div>

        <div class="form-group">
          <label>Pipeline Stage *</label>
          <select id="pipelineStage" required>
            <option value="research">Research</option>
            <option value="initial_contact">Initial Contact</option>
            <option value="qualified">Qualified</option>
            <option value="proposal">Proposal</option>
            <option value="negotiation">Negotiation</option>
            <option value="committed">Committed</option>
            <option value="funded">Funded</option>
          </select>
        </div>

        <div class="form-group">
          <label>Next Action</label>
          <input type="text" id="nextAction">
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="notes"></textarea>
        </div>

        <button type="submit" class="btn-primary">Save Prospect</button>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = 'https://isrs-database-backend.onrender.com/api';
    let prospects = [];
    let draggedCard = null;

    const STAGES = [
      { key: 'research', label: 'Research', emoji: 'üîç' },
      { key: 'initial_contact', label: 'Initial Contact', emoji: 'üìû' },
      { key: 'qualified', label: 'Qualified', emoji: '‚úÖ' },
      { key: 'proposal', label: 'Proposal', emoji: 'üìÑ' },
      { key: 'negotiation', label: 'Negotiation', emoji: 'ü§ù' },
      { key: 'committed', label: 'Committed', emoji: 'üéØ' },
      { key: 'funded', label: 'Funded', emoji: 'üí∞' }
    ];

    async function loadPipeline() {
      try {
        const token = localStorage.getItem('session_token');
        const response = await fetch(`${API_BASE}/admin/funding/prospects`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load prospects');

        const data = await response.json();
        prospects = data.prospects || [];

        renderBoard();
        updateStats();
      } catch (error) {
        console.error('Error loading pipeline:', error);
        document.getElementById('board').innerHTML = '<div class="loading">Error loading pipeline</div>';
      }
    }

    function renderBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';

      STAGES.forEach(stage => {
        const stageProspects = prospects.filter(p => p.pipeline_stage === stage.key);
        const stageTotal = stageProspects.reduce((sum, p) => sum + parseFloat(p.estimated_amount || 0), 0);

        const column = document.createElement('div');
        column.className = 'pipeline-column';
        column.dataset.stage = stage.key;

        column.innerHTML = `
          <div class="column-header">
            <div>
              <div class="column-title">${stage.emoji} ${stage.label}</div>
              <div class="column-value">$${formatNumber(stageTotal)}</div>
            </div>
            <div class="column-count">${stageProspects.length}</div>
          </div>
          <div class="cards-container" id="cards-${stage.key}"></div>
        `;

        // Add drop zone handlers
        const cardsContainer = column.querySelector('.cards-container');
        cardsContainer.addEventListener('dragover', handleDragOver);
        cardsContainer.addEventListener('drop', handleDrop);
        cardsContainer.addEventListener('dragleave', handleDragLeave);

        // Render cards
        stageProspects.forEach(prospect => {
          const card = createProspectCard(prospect);
          cardsContainer.appendChild(card);
        });

        board.appendChild(column);
      });
    }

    function createProspectCard(prospect) {
      const card = document.createElement('div');
      card.className = 'prospect-card';
      card.draggable = true;
      card.dataset.id = prospect.id;

      card.innerHTML = `
        <div class="card-header">
          <div class="card-title">${prospect.organization_name || 'Unnamed Prospect'}</div>
          <div class="card-amount">$${formatNumber(prospect.estimated_amount || 0)}</div>
        </div>
        ${prospect.contact_person ? `<div class="card-meta">üë§ ${prospect.contact_person}</div>` : ''}
        ${prospect.probability_percentage ? `<div class="card-meta">üìä ${prospect.probability_percentage}% probability</div>` : ''}
        ${prospect.next_action ? `<div class="card-meta">‚è≠Ô∏è ${prospect.next_action}</div>` : ''}
        <div class="card-actions">
          <button class="card-btn" onclick="viewProspect(${prospect.id})">View</button>
          <button class="card-btn" onclick="editProspect(${prospect.id})">Edit</button>
        </div>
      `;

      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);

      return card;
    }

    function handleDragStart(e) {
      draggedCard = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.target.innerHTML);
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.classList.add('drag-over');
      return false;
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    async function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      e.currentTarget.classList.remove('drag-over');

      if (draggedCard) {
        const prospectId = parseInt(draggedCard.dataset.id);
        const newStage = e.currentTarget.parentElement.dataset.stage;

        // Update backend
        await updateProspectStage(prospectId, newStage);

        // Move card in DOM
        e.currentTarget.appendChild(draggedCard);

        // Update local data
        const prospect = prospects.find(p => p.id === prospectId);
        if (prospect) {
          prospect.pipeline_stage = newStage;
        }

        updateStats();
        renderBoard();
      }

      return false;
    }

    async function updateProspectStage(prospectId, newStage) {
      try {
        const token = localStorage.getItem('session_token');
        const response = await fetch(`${API_BASE}/admin/funding/prospects/${prospectId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ pipeline_stage: newStage })
        });

        if (!response.ok) throw new Error('Failed to update stage');
      } catch (error) {
        console.error('Error updating stage:', error);
        alert('Failed to move prospect. Please refresh and try again.');
      }
    }

    function updateStats() {
      const active = prospects.filter(p => !['funded', 'declined', 'on_hold'].includes(p.pipeline_stage));
      const total = prospects.reduce((sum, p) => sum + parseFloat(p.estimated_amount || 0), 0);
      const weighted = prospects.reduce((sum, p) =>
        sum + (parseFloat(p.estimated_amount || 0) * (parseInt(p.probability_percentage || 50) / 100)), 0);
      const overdue = prospects.filter(p => p.next_action_due_date && new Date(p.next_action_due_date) < new Date()).length;

      document.getElementById('stat-total').textContent = '$' + formatNumber(total);
      document.getElementById('stat-weighted').textContent = '$' + formatNumber(weighted);
      document.getElementById('stat-active').textContent = active.length;
      document.getElementById('stat-overdue').textContent = overdue;
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(num);
    }

    function showAddProspectModal() {
      document.getElementById('modalTitle').textContent = 'Add New Prospect';
      document.getElementById('prospectForm').reset();
      document.getElementById('prospectId').value = '';
      document.getElementById('prospectModal').classList.add('active');
    }

    function editProspect(id) {
      const prospect = prospects.find(p => p.id === id);
      if (!prospect) return;

      document.getElementById('modalTitle').textContent = 'Edit Prospect';
      document.getElementById('prospectId').value = prospect.id;
      document.getElementById('organizationName').value = prospect.organization_name || '';
      document.getElementById('contactPerson').value = prospect.contact_person || '';
      document.getElementById('estimatedAmount').value = prospect.estimated_amount || '';
      document.getElementById('probability').value = prospect.probability_percentage || 50;
      document.getElementById('pipelineStage').value = prospect.pipeline_stage || 'research';
      document.getElementById('nextAction').value = prospect.next_action || '';
      document.getElementById('notes').value = prospect.notes || '';
      document.getElementById('prospectModal').classList.add('active');
    }

    function viewProspect(id) {
      window.location.href = `/admin/funding.html?id=${id}`;
    }

    function closeModal() {
      document.getElementById('prospectModal').classList.remove('active');
    }

    async function saveProspect(e) {
      e.preventDefault();

      const id = document.getElementById('prospectId').value;
      const data = {
        organization_name: document.getElementById('organizationName').value,
        contact_person: document.getElementById('contactPerson').value,
        estimated_amount: parseFloat(document.getElementById('estimatedAmount').value),
        probability_percentage: parseInt(document.getElementById('probability').value),
        pipeline_stage: document.getElementById('pipelineStage').value,
        next_action: document.getElementById('nextAction').value,
        notes: document.getElementById('notes').value,
        prospect_type: 'organization'
      };

      try {
        const token = localStorage.getItem('session_token');
        const url = id ? `${API_BASE}/admin/funding/prospects/${id}` : `${API_BASE}/admin/funding/prospects`;
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('Failed to save prospect');

        closeModal();
        loadPipeline();
      } catch (error) {
        console.error('Error saving prospect:', error);
        alert('Failed to save prospect. Please try again.');
      }
    }

    function logout() {
      localStorage.removeItem('session_token');
      window.location.href = '/admin/login.html';
    }

    // Check auth and load
    window.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('session_token');
      if (!token) {
        window.location.href = '/admin/login.html';
        return;
      }
      loadPipeline();
    });
  </script>
  <!-- AI Assistant -->
  <script src="/components/ai-assistant.html"></script>
</body>
</html>
