<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Management - ISRS Admin</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin-layout.css">
  <link rel="stylesheet" href="/css/admin-unified.css">
  <script src="/js/theme.js"></script>
  <script src="/js/admin-layout.js"></script>
  <script src="/js/photo-uploader.js"></script>
  <style>
    .photo-admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .photo-admin-header h1 {
      margin: 0;
      color: var(--admin-text, #1f2937);
    }

    .photo-admin-header p {
      margin: 0.25rem 0 0;
      color: var(--admin-text-muted, #6b7280);
      font-size: 0.95rem;
    }

    .photo-stats {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .photo-stat {
      text-align: center;
      padding: 0.75rem 1.25rem;
      background: var(--admin-surface, white);
      border-radius: 8px;
      border: 1px solid var(--admin-border, #e5e7eb);
    }

    .photo-stat .number {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--admin-primary, #2E5A8A);
    }

    .photo-stat .label {
      font-size: 0.75rem;
      color: var(--admin-text-muted, #6b7280);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .admin-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--admin-border, #e5e7eb);
      padding-bottom: 0;
    }

    .admin-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--admin-text-muted, #6b7280);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .admin-tab:hover {
      color: var(--admin-primary, #2E5A8A);
    }

    .admin-tab.active {
      color: var(--admin-primary, #2E5A8A);
      border-bottom-color: var(--admin-primary, #2E5A8A);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Photo Grid */
    .photos-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .photos-search {
      display: flex;
      gap: 0.5rem;
      flex: 1;
      max-width: 400px;
    }

    .photos-search input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--admin-border, #d1d5db);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9375rem;
      background: var(--admin-surface, white);
      color: var(--admin-text, #1f2937);
    }

    .photos-search input:focus {
      outline: none;
      border-color: var(--admin-primary, #2E5A8A);
      box-shadow: 0 0 0 3px rgba(46, 90, 138, 0.1);
    }

    .photos-filters {
      display: flex;
      gap: 0.5rem;
    }

    .photos-filters select {
      padding: 0.625rem 1rem;
      border: 1px solid var(--admin-border, #d1d5db);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.875rem;
      background: var(--admin-surface, white);
      color: var(--admin-text, #1f2937);
      cursor: pointer;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.5rem;
    }

    .photo-card {
      background: var(--admin-surface, white);
      border: 1px solid var(--admin-border, #e5e7eb);
      border-radius: 10px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .photo-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .photo-card-image {
      position: relative;
      height: 180px;
      overflow: hidden;
    }

    .photo-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-card-badges {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      display: flex;
      gap: 0.375rem;
    }

    .photo-badge {
      padding: 0.25rem 0.5rem;
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border-radius: 4px;
      color: var(--admin-surface);
    }

    .photo-badge.public {
      background: #10b981;
    }

    .photo-badge.private {
      background: #6b7280;
    }

    .photo-badge.ai {
      background: #8b5cf6;
    }

    .photo-card-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.25rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .photo-card:hover .photo-card-actions {
      opacity: 1;
    }

    .photo-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: transform 0.1s;
    }

    .photo-action-btn:hover {
      transform: scale(1.1);
    }

    .photo-action-btn.edit {
      background: rgba(255,255,255,0.95);
      color: var(--admin-primary, #2E5A8A);
    }

    .photo-action-btn.delete {
      background: rgba(239, 68, 68, 0.95);
      color: var(--admin-surface);
    }

    .photo-card-info {
      padding: 1rem;
    }

    .photo-card-title {
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--admin-text, #1f2937);
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .photo-card-meta {
      font-size: 0.8125rem;
      color: var(--admin-text-muted, #6b7280);
      display: flex;
      gap: 0.75rem;
    }

    .photo-card-tags {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.375rem;
      flex-wrap: wrap;
    }

    .photo-tag {
      font-size: 0.6875rem;
      padding: 0.125rem 0.375rem;
      background: var(--admin-gray-100, #f3f4f6);
      color: var(--admin-text-secondary, #4b5563);
      border-radius: 3px;
    }

    /* Empty State */
    .photos-empty {
      text-align: center;
      padding: 4rem 2rem;
      background: var(--admin-surface, white);
      border: 2px dashed var(--admin-border, #e5e7eb);
      border-radius: 12px;
    }

    .photos-empty svg {
      width: 64px;
      height: 64px;
      color: var(--admin-text-muted, #9ca3af);
      margin-bottom: 1rem;
    }

    .photos-empty h3 {
      margin: 0 0 0.5rem;
      color: var(--admin-text, #1f2937);
    }

    .photos-empty p {
      margin: 0 0 1.5rem;
      color: var(--admin-text-muted, #6b7280);
    }

    /* Loading State */
    .photos-loading {
      text-align: center;
      padding: 3rem;
      color: var(--admin-text-muted, #6b7280);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--admin-border, #e5e7eb);
      border-top-color: var(--admin-primary, #2E5A8A);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Photo Detail Modal */
    .photo-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .photo-modal-overlay.active {
      display: flex;
    }

    .photo-modal {
      background: var(--admin-surface, white);
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .photo-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--admin-border, #e5e7eb);
    }

    .photo-modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--admin-text, #1f2937);
    }

    .photo-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--admin-text-muted, #9ca3af);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .photo-modal-close:hover {
      color: var(--admin-text, #1f2937);
    }

    .photo-modal-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      padding: 1.5rem;
    }

    @media (max-width: 768px) {
      .photo-modal-body {
        grid-template-columns: 1fr;
      }
    }

    .photo-modal-image img {
      width: 100%;
      border-radius: 8px;
    }

    .photo-modal-details h3 {
      margin: 0 0 0.5rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--admin-text-muted, #6b7280);
    }

    .photo-modal-details p {
      margin: 0 0 1.5rem;
      color: var(--admin-text, #1f2937);
    }

    .photo-modal-ai {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .photo-modal-ai h4 {
      margin: 0 0 0.75rem;
      color: #8b5cf6;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .photo-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--admin-border, #e5e7eb);
      background: var(--admin-gray-50, #f9fafb);
    }

    .btn {
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--admin-primary, #2E5A8A);
      color: var(--admin-surface);
      border: none;
    }

    .btn-primary:hover {
      background: #3d6a9a;
    }

    .btn-secondary {
      background: var(--admin-surface, white);
      color: var(--admin-text-secondary, #374151);
      border: 1px solid var(--admin-border, #d1d5db);
    }

    .btn-secondary:hover {
      background: var(--admin-gray-50, #f3f4f6);
    }

    .btn-danger {
      background: #ef4444;
      color: var(--admin-surface);
      border: none;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* Dark mode adjustments */
    .admin-dark-mode .photo-card {
      background: #1f2937;
      border-color: #374151;
    }

    .admin-dark-mode .photos-empty {
      background: #1f2937;
      border-color: #374151;
    }

    .admin-dark-mode .photo-modal {
      background: #1f2937;
    }

    .admin-dark-mode .photo-tag {
      background: #374151;
      color: #e5e7eb;
    }
  </style>
</head>
<body class="admin-page">
  <div class="admin-content-padded">
    <div class="admin-card">
      <div class="admin-card-body">
        <div class="photo-admin-header">
          <div>
            <h1>Photo Management</h1>
            <p>Upload, organize, and manage photos for the ISRS gallery and press kit</p>
            <div class="admin-alert admin-alert-info" style="margin-top: 1rem; padding: 0.75rem 1rem; border-radius: 6px;">
              <strong>âœ¨ AI-Powered Features:</strong> Photos are automatically analyzed using Claude AI to generate intelligent titles, descriptions, tags, and categorization. Upload via file or URL, and let AI handle the metadata.
            </div>
          </div>
          <div class="photo-stats" id="photoStats">
            <div class="photo-stat">
              <div class="number" id="totalPhotos">-</div>
              <div class="label">Total Photos</div>
            </div>
            <div class="photo-stat">
              <div class="number" id="publicPhotos">-</div>
              <div class="label">Public</div>
            </div>
            <div class="photo-stat">
              <div class="number" id="aiAnalyzed">-</div>
              <div class="label">AI Analyzed</div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="gallery">Gallery</button>
          <button class="admin-tab" data-tab="upload">Upload Photos</button>
        </div>

        <!-- Gallery Tab -->
        <div class="tab-panel active" id="gallery-panel">
          <div class="photos-toolbar">
            <div class="photos-search">
              <input type="text" id="searchInput" placeholder="Search photos...">
            </div>
            <div class="photos-filters">
              <select id="visibilityFilter">
                <option value="">All Photos</option>
                <option value="public">Public Only</option>
                <option value="private">Private Only</option>
              </select>
              <select id="sortOrder">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="name">By Name</option>
              </select>
            </div>
          </div>

          <div id="photosContainer">
            <div class="photos-loading">
              <div class="spinner"></div>
              <p>Loading photos...</p>
            </div>
          </div>
        </div>

        <!-- Upload Tab -->
        <div class="tab-panel" id="upload-panel">
          <!-- URL Upload Section -->
          <div class="admin-card" style="margin-bottom: 2rem;">
            <div class="admin-card-header">
              <h3>Upload from URL</h3>
            </div>
            <div class="admin-card-body">
              <p style="margin-bottom: 1rem; color: var(--admin-text-muted);">Enter photo URLs (one per line) to download and upload them to the gallery.</p>
              <textarea id="urlInput" rows="4" class="admin-input" placeholder="https://example.com/photo1.jpg&#10;https://example.com/photo2.jpg" style="width: 100%; margin-bottom: 1rem; font-family: monospace; font-size: 0.875rem;"></textarea>
              <button type="button" class="admin-btn admin-btn-primary" id="uploadFromUrlBtn">
                <span id="urlUploadText">Upload from URLs</span>
                <span id="urlUploadSpinner" style="display: none;">Processing...</span>
              </button>
            </div>
          </div>

          <!-- File Upload Section -->
          <div id="photo-uploader"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo Detail Modal -->
  <div class="photo-modal-overlay" id="photoModal">
    <div class="photo-modal">
      <div class="photo-modal-header">
        <h2 id="modalTitle">Photo Details</h2>
        <button class="photo-modal-close" onclick="closePhotoModal()">&times;</button>
      </div>
      <div class="photo-modal-body">
        <div class="photo-modal-image">
          <img id="modalImage" src="" alt="">
        </div>
        <div class="photo-modal-details" id="modalDetails">
          <!-- Populated by JS -->
        </div>
      </div>
      <div class="photo-modal-footer">
        <button class="btn btn-danger" onclick="deleteCurrentPhoto()">Delete Photo</button>
        <button class="btn btn-secondary" id="toggleVisibilityBtn">Make Public</button>
        <button class="btn btn-primary" onclick="closePhotoModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000'
      : 'https://isrs-database-backend.onrender.com';

    let allPhotos = [];
    let currentPhoto = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadAdminLayout('photos');
      initTabs();
      initUploader();
      loadPhotos();
      initFilters();
    });

    // Tab switching
    function initTabs() {
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;

          // Update tabs
          document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Update panels
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          document.getElementById(`${tabName}-panel`).classList.add('active');
        });
      });
    }

    // Initialize photo uploader
    function initUploader() {
      new PhotoUploader('photo-uploader', {
        maxFiles: 10,
        maxFileSize: 25,
        onUploadComplete: (photos) => {
          console.log('Upload complete!', photos);
          // Switch to gallery tab and reload
          document.querySelector('[data-tab="gallery"]').click();
          loadPhotos();
        },
        onUploadError: (filename, error) => {
          console.error(`Error uploading ${filename}:`, error);
        }
      });

      // Initialize URL upload button
      const urlUploadBtn = document.getElementById('uploadFromUrlBtn');
      if (urlUploadBtn) {
        urlUploadBtn.addEventListener('click', handleUrlUpload);
      }
    }

    // Handle URL upload
    async function handleUrlUpload() {
      const urlInput = document.getElementById('urlInput');
      const uploadBtn = document.getElementById('uploadFromUrlBtn');
      const uploadText = document.getElementById('urlUploadText');
      const uploadSpinner = document.getElementById('urlUploadSpinner');
      const sessionToken = localStorage.getItem('isrs_session');

      if (!sessionToken) {
        alert('Please log in to upload photos');
        return;
      }

      const urls = urlInput.value.trim().split('\n').filter(url => url.trim());

      if (urls.length === 0) {
        alert('Please enter at least one URL');
        return;
      }

      // Disable button and show spinner
      uploadBtn.disabled = true;
      uploadText.style.display = 'none';
      uploadSpinner.style.display = 'inline';

      try {
        const response = await fetch(`${API_BASE_URL}/api/photos/upload-url`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionToken}`
          },
          body: JSON.stringify({ urls })
        });

        const data = await response.json();

        if (data.success) {
          alert(`Successfully uploaded ${data.data.length} photo(s) from URLs!`);
          urlInput.value = '';
          // Switch to gallery tab and reload
          document.querySelector('[data-tab="gallery"]').click();
          loadPhotos();
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (error) {
        console.error('URL upload error:', error);
        alert(`Failed to upload from URLs: ${error.message}`);
      } finally {
        // Re-enable button
        uploadBtn.disabled = false;
        uploadText.style.display = 'inline';
        uploadSpinner.style.display = 'none';
      }
    }

    // Load photos from API
    async function loadPhotos() {
      const container = document.getElementById('photosContainer');
      const sessionToken = localStorage.getItem('isrs_session');

      if (!sessionToken) {
        container.innerHTML = `
          <div class="photos-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12" y2="16"></line>
            </svg>
            <h3>Not Logged In</h3>
            <p>Please log in to manage photos</p>
          </div>
        `;
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/photos`, {
          headers: {
            'Authorization': `Bearer ${sessionToken}`
          }
        });

        const data = await response.json();

        if (data.success && data.data) {
          allPhotos = data.data;
          updateStats();
          renderPhotos(allPhotos);
        } else {
          throw new Error(data.error || 'Failed to load photos');
        }
      } catch (error) {
        console.error('Error loading photos:', error);
        container.innerHTML = `
          <div class="photos-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <h3>No Photos Yet</h3>
            <p>Upload your first photos using the Upload tab</p>
            <button class="btn btn-primary" onclick="document.querySelector('[data-tab=\\'upload\\']').click()">
              Upload Photos
            </button>
          </div>
        `;
      }
    }

    // Update statistics
    function updateStats() {
      document.getElementById('totalPhotos').textContent = allPhotos.length;
      document.getElementById('publicPhotos').textContent = allPhotos.filter(p => p.is_public).length;
      document.getElementById('aiAnalyzed').textContent = allPhotos.filter(p => p.ai_analysis).length;
    }

    // Render photo grid
    function renderPhotos(photos) {
      const container = document.getElementById('photosContainer');

      if (photos.length === 0) {
        container.innerHTML = `
          <div class="photos-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <h3>No Photos Found</h3>
            <p>No photos match your current filters</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="photo-grid">
          ${photos.map(photo => `
            <div class="photo-card" onclick="openPhotoModal(${photo.id})">
              <div class="photo-card-image">
                <img src="${photo.thumbnail_url || photo.url}" alt="${photo.caption || photo.original_filename}">
                <div class="photo-card-badges">
                  ${photo.is_public ? '<span class="photo-badge public">Public</span>' : '<span class="photo-badge private">Private</span>'}
                  ${photo.ai_analysis ? '<span class="photo-badge ai">AI</span>' : ''}
                </div>
                <div class="photo-card-actions">
                  <button class="photo-action-btn edit" onclick="event.stopPropagation(); openPhotoModal(${photo.id})" title="View/Edit">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button class="photo-action-btn delete" onclick="event.stopPropagation(); deletePhoto(${photo.id})" title="Delete">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="photo-card-info">
                <div class="photo-card-title">${photo.caption || photo.original_filename}</div>
                <div class="photo-card-meta">
                  <span>${photo.width}x${photo.height}</span>
                  <span>${formatFileSize(photo.file_size_bytes)}</span>
                </div>
                ${photo.tags && photo.tags.length > 0 ? `
                  <div class="photo-card-tags">
                    ${photo.tags.slice(0, 3).map(tag => `<span class="photo-tag">${tag}</span>`).join('')}
                    ${photo.tags.length > 3 ? `<span class="photo-tag">+${photo.tags.length - 3}</span>` : ''}
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Filters
    function initFilters() {
      const searchInput = document.getElementById('searchInput');
      const visibilityFilter = document.getElementById('visibilityFilter');
      const sortOrder = document.getElementById('sortOrder');

      const applyFilters = () => {
        let filtered = [...allPhotos];

        // Search
        const search = searchInput.value.toLowerCase();
        if (search) {
          filtered = filtered.filter(p =>
            (p.caption && p.caption.toLowerCase().includes(search)) ||
            (p.original_filename && p.original_filename.toLowerCase().includes(search)) ||
            (p.tags && p.tags.some(t => t.toLowerCase().includes(search))) ||
            (p.location_name && p.location_name.toLowerCase().includes(search))
          );
        }

        // Visibility
        const visibility = visibilityFilter.value;
        if (visibility === 'public') {
          filtered = filtered.filter(p => p.is_public);
        } else if (visibility === 'private') {
          filtered = filtered.filter(p => !p.is_public);
        }

        // Sort
        const sort = sortOrder.value;
        if (sort === 'newest') {
          filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sort === 'oldest') {
          filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        } else if (sort === 'name') {
          filtered.sort((a, b) => (a.caption || a.original_filename).localeCompare(b.caption || b.original_filename));
        }

        renderPhotos(filtered);
      };

      searchInput.addEventListener('input', applyFilters);
      visibilityFilter.addEventListener('change', applyFilters);
      sortOrder.addEventListener('change', applyFilters);
    }

    // Photo modal
    function openPhotoModal(photoId) {
      const photo = allPhotos.find(p => p.id === photoId);
      if (!photo) return;

      currentPhoto = photo;

      document.getElementById('modalTitle').textContent = photo.caption || photo.original_filename;
      document.getElementById('modalImage').src = photo.url;
      document.getElementById('modalImage').alt = photo.caption || '';

      const toggleBtn = document.getElementById('toggleVisibilityBtn');
      toggleBtn.textContent = photo.is_public ? 'Make Private' : 'Make Public';

      const details = document.getElementById('modalDetails');
      const aiAnalysis = photo.ai_analysis;

      details.innerHTML = `
        <h3>Caption</h3>
        <p>${photo.caption || 'No caption'}</p>

        <h3>Description</h3>
        <p>${photo.description || 'No description'}</p>

        <h3>Details</h3>
        <p>
          <strong>Filename:</strong> ${photo.original_filename}<br>
          <strong>Dimensions:</strong> ${photo.width} x ${photo.height}<br>
          <strong>Size:</strong> ${formatFileSize(photo.file_size_bytes)}<br>
          <strong>Uploaded:</strong> ${new Date(photo.created_at).toLocaleDateString()}<br>
          <strong>License:</strong> ${photo.license_type || 'Not specified'}<br>
          ${photo.photographer_name ? `<strong>Photographer:</strong> ${photo.photographer_name}<br>` : ''}
          ${photo.location_name ? `<strong>Location:</strong> ${photo.location_name}<br>` : ''}
        </p>

        ${photo.tags && photo.tags.length > 0 ? `
          <h3>Tags</h3>
          <p>${photo.tags.map(t => `<span class="photo-tag">${t}</span>`).join(' ')}</p>
        ` : ''}

        ${aiAnalysis ? `
          <div class="photo-modal-ai">
            <h4>AI Analysis</h4>
            ${aiAnalysis.description ? `<p><strong>AI Description:</strong> ${aiAnalysis.description}</p>` : ''}
            ${aiAnalysis.species && aiAnalysis.species.length > 0 ? `<p><strong>Species Detected:</strong> ${aiAnalysis.species.join(', ')}</p>` : ''}
            ${aiAnalysis.habitat_type ? `<p><strong>Habitat Type:</strong> ${aiAnalysis.habitat_type}</p>` : ''}
            ${aiAnalysis.restoration_technique ? `<p><strong>Restoration Technique:</strong> ${aiAnalysis.restoration_technique}</p>` : ''}
            ${aiAnalysis.keywords && aiAnalysis.keywords.length > 0 ? `<p><strong>AI Keywords:</strong> ${aiAnalysis.keywords.join(', ')}</p>` : ''}
          </div>
        ` : ''}
      `;

      document.getElementById('photoModal').classList.add('active');
    }

    function closePhotoModal() {
      document.getElementById('photoModal').classList.remove('active');
      currentPhoto = null;
    }

    // Toggle visibility
    document.getElementById('toggleVisibilityBtn').addEventListener('click', async () => {
      if (!currentPhoto) return;

      const sessionToken = localStorage.getItem('isrs_session');
      if (!sessionToken) return;

      try {
        const response = await fetch(`${API_BASE_URL}/api/photos/${currentPhoto.id}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${sessionToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_public: !currentPhoto.is_public })
        });

        const data = await response.json();
        if (data.success) {
          // Update local data
          const idx = allPhotos.findIndex(p => p.id === currentPhoto.id);
          if (idx !== -1) {
            allPhotos[idx].is_public = !currentPhoto.is_public;
          }
          closePhotoModal();
          updateStats();
          renderPhotos(allPhotos);
        } else {
          alert('Failed to update photo: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error updating photo:', error);
        alert('Failed to update photo');
      }
    });

    // Delete photo
    async function deletePhoto(photoId) {
      if (!confirm('Are you sure you want to delete this photo? This cannot be undone.')) {
        return;
      }

      const sessionToken = localStorage.getItem('isrs_session');
      if (!sessionToken) return;

      try {
        const response = await fetch(`${API_BASE_URL}/api/photos/${photoId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${sessionToken}`
          }
        });

        const data = await response.json();
        if (data.success) {
          allPhotos = allPhotos.filter(p => p.id !== photoId);
          updateStats();
          renderPhotos(allPhotos);
        } else {
          alert('Failed to delete photo: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error deleting photo:', error);
        alert('Failed to delete photo');
      }
    }

    function deleteCurrentPhoto() {
      if (currentPhoto) {
        closePhotoModal();
        deletePhoto(currentPhoto.id);
      }
    }

    // Utility
    function formatFileSize(bytes) {
      if (!bytes) return 'Unknown';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePhotoModal();
    });

    // Close modal on backdrop click
    document.getElementById('photoModal').addEventListener('click', (e) => {
      if (e.target.id === 'photoModal') closePhotoModal();
    });
  </script>
</body>
</html>
