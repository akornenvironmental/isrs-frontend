<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Feedback - ISRS Admin</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marcellus&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/admin-layout.css">
  <link rel="stylesheet" href="/css/admin-unified.css">
  <style>
    /* Feedback page specific styles */
    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--admin-space-2xl);
      flex-wrap: wrap;
      gap: var(--admin-space-lg);
    }

    .feedback-header h1 {
      font-size: var(--admin-text-2xl);
      margin: 0;
    }

    .feedback-filters {
      display: flex;
      gap: var(--admin-space-lg);
      flex-wrap: wrap;
    }

    .feedback-filters select {
      padding: var(--admin-space-md) var(--admin-space-lg);
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-md);
      background: var(--admin-surface);
      color: var(--admin-text);
      font-size: var(--admin-text-sm);
      min-width: 150px;
    }

    /* Stats cards */
    .feedback-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--admin-space-lg);
      margin-bottom: var(--admin-space-2xl);
    }

    .stat-card {
      background: var(--admin-surface);
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-lg);
      padding: var(--admin-space-xl);
      text-align: center;
    }

    .stat-card .stat-value {
      font-size: var(--admin-text-2xl);
      font-weight: 700;
      color: var(--admin-text);
    }

    .stat-card .stat-label {
      font-size: var(--admin-text-sm);
      color: var(--admin-text-muted);
      margin-top: var(--admin-space-xs);
    }

    .stat-card.bugs { border-left: 4px solid #d32f2f; }
    .stat-card.features { border-left: 4px solid #1976d2; }
    .stat-card.improvements { border-left: 4px solid #388e3c; }
    .stat-card.general { border-left: 4px solid #7b1fa2; }

    /* Feedback list */
    .feedback-list {
      display: flex;
      flex-direction: column;
      gap: var(--admin-space-lg);
    }

    .feedback-item {
      background: var(--admin-surface);
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-lg);
      padding: var(--admin-space-xl);
      transition: all 0.2s;
    }

    .feedback-item:hover {
      box-shadow: var(--admin-shadow-md);
    }

    .feedback-item.unread {
      border-left: 4px solid var(--admin-primary);
    }

    .feedback-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--admin-space-lg);
      flex-wrap: wrap;
      gap: var(--admin-space-md);
    }

    .feedback-meta {
      display: flex;
      flex-direction: column;
      gap: var(--admin-space-xs);
    }

    .feedback-user {
      font-weight: 600;
      color: var(--admin-text);
      font-size: var(--admin-text-md);
    }

    .feedback-email {
      color: var(--admin-primary);
      font-size: var(--admin-text-sm);
      text-decoration: none;
    }

    .feedback-email:hover {
      text-decoration: underline;
    }

    .feedback-timestamp {
      color: var(--admin-text-muted);
      font-size: var(--admin-text-xs);
    }

    .feedback-badges {
      display: flex;
      gap: var(--admin-space-sm);
      flex-wrap: wrap;
    }

    .feedback-type-badge {
      padding: var(--admin-space-xs) var(--admin-space-md);
      border-radius: var(--admin-radius-full);
      font-size: var(--admin-text-xs);
      font-weight: 600;
      text-transform: uppercase;
    }

    .feedback-type-badge.bug {
      background: #ffebee;
      color: #d32f2f;
    }

    .feedback-type-badge.feature_request {
      background: #e3f2fd;
      color: #1976d2;
    }

    .feedback-type-badge.improvement {
      background: #e8f5e9;
      color: #388e3c;
    }

    .feedback-type-badge.general {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .feedback-source-badge {
      padding: var(--admin-space-xs) var(--admin-space-md);
      border-radius: var(--admin-radius-full);
      font-size: var(--admin-text-xs);
      font-weight: 600;
    }

    .feedback-source-badge.admin {
      background: #fce4ec;
      color: #c2185b;
    }

    .feedback-source-badge.public {
      background: #fff3e0;
      color: #f57c00;
    }

    .feedback-status-badge {
      padding: var(--admin-space-xs) var(--admin-space-md);
      border-radius: var(--admin-radius-full);
      font-size: var(--admin-text-xs);
      font-weight: 600;
    }

    .feedback-status-badge.new {
      background: var(--admin-primary-light);
      color: var(--admin-primary);
    }

    .feedback-status-badge.reviewed {
      background: var(--admin-success-bg);
      color: var(--admin-success);
    }

    .feedback-status-badge.in_progress {
      background: var(--admin-warning-bg);
      color: var(--admin-warning);
    }

    .feedback-status-badge.resolved {
      background: var(--admin-gray-100);
      color: var(--admin-gray-600);
    }

    .feedback-message {
      color: var(--admin-text);
      line-height: 1.6;
      margin-bottom: var(--admin-space-lg);
      white-space: pre-wrap;
    }

    .feedback-page-info {
      background: var(--admin-surface-hover);
      padding: var(--admin-space-md) var(--admin-space-lg);
      border-radius: var(--admin-radius-md);
      font-size: var(--admin-text-sm);
      color: var(--admin-text-secondary);
    }

    .feedback-page-info strong {
      color: var(--admin-text);
    }

    .feedback-page-url {
      word-break: break-all;
      color: var(--admin-text-muted);
      font-size: var(--admin-text-xs);
      margin-top: var(--admin-space-xs);
    }

    .feedback-actions {
      display: flex;
      gap: var(--admin-space-md);
      margin-top: var(--admin-space-lg);
      padding-top: var(--admin-space-lg);
      border-top: 1px solid var(--admin-border);
    }

    .feedback-action-btn {
      padding: var(--admin-space-sm) var(--admin-space-lg);
      border-radius: var(--admin-radius-md);
      font-size: var(--admin-text-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--admin-border);
      background: var(--admin-surface);
      color: var(--admin-text);
    }

    .feedback-action-btn:hover {
      background: var(--admin-surface-hover);
    }

    .feedback-action-btn.primary {
      background: var(--admin-primary);
      color: white;
      border-color: var(--admin-primary);
    }

    .feedback-action-btn.primary:hover {
      background: var(--admin-primary-hover);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--admin-space-4xl);
      color: var(--admin-text-muted);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: var(--admin-space-lg);
    }

    .empty-state h3 {
      color: var(--admin-text);
      margin-bottom: var(--admin-space-md);
    }

    /* Loading state */
    .loading-state {
      text-align: center;
      padding: var(--admin-space-4xl);
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--admin-space-md);
      margin-top: var(--admin-space-2xl);
    }

    .pagination-btn {
      padding: var(--admin-space-md) var(--admin-space-xl);
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius-md);
      background: var(--admin-surface);
      color: var(--admin-text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--admin-surface-hover);
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-info {
      color: var(--admin-text-muted);
      font-size: var(--admin-text-sm);
    }

    @media (max-width: 768px) {
      .feedback-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .feedback-filters {
        width: 100%;
      }

      .feedback-filters select {
        flex: 1;
      }

      .feedback-item-header {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="admin-page">
  <div class="admin-content-padded">
    <!-- Header -->
    <div class="feedback-header">
      <div>
        <h1>User Feedback</h1>
        <p style="color: var(--admin-text-muted); margin-top: var(--admin-space-xs);">View and manage feedback from beta testers and users</p>
      </div>
      <div class="feedback-filters">
        <select id="filterType" onchange="loadFeedback()">
          <option value="">All Types</option>
          <option value="bug">Bug Reports</option>
          <option value="feature_request">Feature Requests</option>
          <option value="improvement">Improvements</option>
          <option value="general">General</option>
        </select>
        <select id="filterStatus" onchange="loadFeedback()">
          <option value="">All Status</option>
          <option value="new">New</option>
          <option value="reviewed">Reviewed</option>
          <option value="in_progress">In Progress</option>
          <option value="resolved">Resolved</option>
        </select>
        <select id="filterSource" onchange="loadFeedback()">
          <option value="">All Sources</option>
          <option value="true">Admin Portal</option>
          <option value="false">Public Site</option>
        </select>
        <select id="sortOrder" onchange="loadFeedback()">
          <option value="date-desc">Newest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="user-asc">User (A-Z)</option>
          <option value="user-desc">User (Z-A)</option>
          <option value="type-asc">Type (A-Z)</option>
          <option value="type-desc">Type (Z-A)</option>
        </select>
      </div>
    </div>

    <!-- Stats -->
    <div class="feedback-stats" id="feedbackStats">
      <div class="stat-card">
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-label">Total Feedback</div>
      </div>
      <div class="stat-card bugs">
        <div class="stat-value" id="statBugs">-</div>
        <div class="stat-label">Bug Reports</div>
      </div>
      <div class="stat-card features">
        <div class="stat-value" id="statFeatures">-</div>
        <div class="stat-label">Feature Requests</div>
      </div>
      <div class="stat-card improvements">
        <div class="stat-value" id="statImprovements">-</div>
        <div class="stat-label">Improvements</div>
      </div>
      <div class="stat-card general">
        <div class="stat-value" id="statGeneral">-</div>
        <div class="stat-label">General</div>
      </div>
    </div>

    <!-- Feedback List -->
    <div id="feedbackContainer">
      <div class="loading-state">
        <div class="admin-spinner" style="margin: 0 auto var(--admin-space-lg);"></div>
        <p>Loading feedback...</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination" style="display: none;">
      <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">Previous</button>
      <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
      <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">Next</button>
    </div>
  </div>

  <script src="/js/admin-layout.js"></script>
  <script>
    const API_BASE_URL = 'https://isrs-database-backend.onrender.com';
    let currentPage = 0;
    const pageSize = 20;
    let totalFeedback = 0;
    let allFeedback = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadAdminLayout('feedback');
      checkAuth();
    });

    function checkAuth() {
      const sessionToken = localStorage.getItem('isrs_session_token');
      if (!sessionToken) {
        window.location.href = '/admin/';
        return;
      }

      fetch(`${API_BASE_URL}/api/auth/session`, {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          localStorage.clear();
          window.location.href = '/admin/';
        } else {
          loadFeedback();
        }
      })
      .catch(() => {
        localStorage.clear();
        window.location.href = '/admin/';
      });
    }

    async function loadFeedback() {
      const sessionToken = localStorage.getItem('isrs_session_token');
      const filterType = document.getElementById('filterType').value;
      const filterStatus = document.getElementById('filterStatus').value;
      const filterSource = document.getElementById('filterSource').value;

      try {
        let url = `${API_BASE_URL}/api/feedback?limit=500`;
        if (filterType) url += `&feedback_type=${filterType}`;
        if (filterStatus) url += `&status=${filterStatus}`;
        if (filterSource) url += `&is_admin_portal=${filterSource}`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${sessionToken}` }
        });

        const data = await response.json();

        if (data.success) {
          allFeedback = data.data;
          totalFeedback = data.total || data.data.length;
          updateStats(data.data);
          currentPage = 0;
          renderFeedback();
        } else {
          showError('Failed to load feedback: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error loading feedback:', error);
        showError('Error loading feedback. Please try again.');
      }
    }

    function updateStats(feedback) {
      document.getElementById('statTotal').textContent = feedback.length;
      document.getElementById('statBugs').textContent = feedback.filter(f => f.feedback_type === 'bug').length;
      document.getElementById('statFeatures').textContent = feedback.filter(f => f.feedback_type === 'feature_request').length;
      document.getElementById('statImprovements').textContent = feedback.filter(f => f.feedback_type === 'improvement').length;
      document.getElementById('statGeneral').textContent = feedback.filter(f => f.feedback_type === 'general').length;
    }

    function sortFeedback(feedbackList) {
      const sortOrder = document.getElementById('sortOrder')?.value || 'date-desc';
      const sorted = [...feedbackList];

      sorted.sort((a, b) => {
        let aVal, bVal;

        switch(sortOrder) {
          case 'date-desc':
            aVal = new Date(a.created_at || 0).getTime();
            bVal = new Date(b.created_at || 0).getTime();
            return bVal - aVal;
          case 'date-asc':
            aVal = new Date(a.created_at || 0).getTime();
            bVal = new Date(b.created_at || 0).getTime();
            return aVal - bVal;
          case 'user-asc':
            return (a.user_name || a.user_email || '').localeCompare(b.user_name || b.user_email || '');
          case 'user-desc':
            return (b.user_name || b.user_email || '').localeCompare(a.user_name || a.user_email || '');
          case 'type-asc':
            return (a.feedback_type || '').localeCompare(b.feedback_type || '');
          case 'type-desc':
            return (b.feedback_type || '').localeCompare(a.feedback_type || '');
          default:
            return 0;
        }
      });

      return sorted;
    }

    function renderFeedback() {
      const container = document.getElementById('feedbackContainer');
      const paginationEl = document.getElementById('pagination');

      const sortedFeedback = sortFeedback(allFeedback);
      const startIdx = currentPage * pageSize;
      const endIdx = startIdx + pageSize;
      const pageData = sortedFeedback.slice(startIdx, endIdx);
      const totalPages = Math.ceil(sortedFeedback.length / pageSize);

      if (allFeedback.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“­</div>
            <h3>No feedback yet</h3>
            <p>Feedback from users will appear here once submitted.</p>
          </div>
        `;
        paginationEl.style.display = 'none';
        return;
      }

      container.innerHTML = `
        <div class="feedback-list">
          ${pageData.map(item => renderFeedbackItem(item)).join('')}
        </div>
      `;

      // Update pagination
      if (totalPages > 1) {
        paginationEl.style.display = 'flex';
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;
        document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages}`;
      } else {
        paginationEl.style.display = 'none';
      }
    }

    function renderFeedbackItem(item) {
      const date = new Date(item.created_at);
      const formattedDate = date.toLocaleDateString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const userName = item.user_name || 'Anonymous';
      const userEmail = item.user_email || null;
      const status = item.status || 'new';

      return `
        <div class="feedback-item ${status === 'new' ? 'unread' : ''}">
          <div class="feedback-item-header">
            <div class="feedback-meta">
              <div class="feedback-user">${escapeHtml(userName)}</div>
              ${userEmail ? `<a href="mailto:${userEmail}" class="feedback-email">${userEmail}</a>` : '<span class="feedback-email" style="color: var(--admin-text-muted);">No email provided</span>'}
              <div class="feedback-timestamp">${formattedDate}</div>
            </div>
            <div class="feedback-badges">
              <span class="feedback-type-badge ${item.feedback_type}">${formatType(item.feedback_type)}</span>
              <span class="feedback-source-badge ${item.is_admin_portal ? 'admin' : 'public'}">${item.is_admin_portal ? 'Admin Portal' : 'Public Site'}</span>
              <span class="feedback-status-badge ${status}">${formatStatus(status)}</span>
            </div>
          </div>

          <div class="feedback-message">${escapeHtml(item.message)}</div>

          <div class="feedback-page-info">
            <strong>Page:</strong> ${item.page_title || item.component_name || 'Unknown'}
            <div class="feedback-page-url">${item.page_url || 'No URL recorded'}</div>
          </div>

          <div class="feedback-actions">
            <button class="feedback-action-btn" onclick="updateStatus('${item.id}', 'reviewed')">Mark Reviewed</button>
            <button class="feedback-action-btn" onclick="updateStatus('${item.id}', 'in_progress')">In Progress</button>
            <button class="feedback-action-btn primary" onclick="updateStatus('${item.id}', 'resolved')">Resolved</button>
            ${userEmail ? `<a href="mailto:${userEmail}?subject=Re: Your feedback on ISRS" class="feedback-action-btn">Reply</a>` : ''}
          </div>
        </div>
      `;
    }

    function formatType(type) {
      const types = {
        bug: 'Bug',
        feature_request: 'Feature',
        improvement: 'Improvement',
        general: 'General'
      };
      return types[type] || type;
    }

    function formatStatus(status) {
      const statuses = {
        new: 'New',
        reviewed: 'Reviewed',
        in_progress: 'In Progress',
        resolved: 'Resolved'
      };
      return statuses[status] || status;
    }

    async function updateStatus(id, newStatus) {
      const sessionToken = localStorage.getItem('isrs_session_token');

      try {
        const response = await fetch(`${API_BASE_URL}/api/feedback/${id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionToken}`
          },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (data.success) {
          // Update local data and re-render
          const idx = allFeedback.findIndex(f => f.id === id);
          if (idx !== -1) {
            allFeedback[idx].status = newStatus;
            renderFeedback();
          }
        } else {
          alert('Failed to update status: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating status. Please try again.');
      }
    }

    function changePage(delta) {
      const totalPages = Math.ceil(allFeedback.length / pageSize);
      const newPage = currentPage + delta;

      if (newPage >= 0 && newPage < totalPages) {
        currentPage = newPage;
        renderFeedback();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function showError(message) {
      document.getElementById('feedbackContainer').innerHTML = `
        <div class="admin-alert admin-alert-danger">
          <p style="margin: 0;">${escapeHtml(message)}</p>
        </div>
      `;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
